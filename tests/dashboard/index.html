<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI产品经理 - 测试仪表板</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.4.3/dist/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.3/dist/index.full.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
    }
    #app {
      padding: 20px;
    }
    .dashboard-header {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }
    .chart-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .chart {
      width: 100%;
      height: 400px;
    }
    .test-list {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }
    .filters {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="dashboard-header">
      <h1>AI产品经理 - 测试仪表板</h1>
      <el-row :gutter="20">
        <el-col :span="6">
          <el-statistic title="最后更新" :value="lastUpdate" />
        </el-col>
        <el-col :span="6">
          <el-statistic title="测试环境" :value="environment" />
        </el-col>
        <el-col :span="6">
          <el-statistic title="总执行时间" :value="totalDuration" suffix="秒" />
        </el-col>
        <el-col :span="6">
          <el-button type="primary" @click="refreshData">刷新数据</el-button>
          <el-button @click="runTests">运行测试</el-button>
        </el-col>
      </el-row>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <el-statistic title="总测试数" :value="stats.total" />
        <el-progress :percentage="100" :color="colors.total" />
      </div>
      <div class="stat-card">
        <el-statistic title="通过" :value="stats.passed" value-style="color: #67c23a" />
        <el-progress :percentage="stats.passedPercent" color="#67c23a" />
      </div>
      <div class="stat-card">
        <el-statistic title="失败" :value="stats.failed" value-style="color: #f56c6c" />
        <el-progress :percentage="stats.failedPercent" color="#f56c6c" />
      </div>
      <div class="stat-card">
        <el-statistic title="跳过" :value="stats.skipped" value-style="color: #e6a23c" />
        <el-progress :percentage="stats.skippedPercent" color="#e6a23c" />
      </div>
    </div>

    <el-row :gutter="20">
      <el-col :span="12">
        <div class="chart-container">
          <h3>测试套件分布</h3>
          <div id="suiteChart" class="chart"></div>
        </div>
      </el-col>
      <el-col :span="12">
        <div class="chart-container">
          <h3>测试趋势</h3>
          <div id="trendChart" class="chart"></div>
        </div>
      </el-col>
    </el-row>

    <el-row :gutter="20">
      <el-col :span="12">
        <div class="chart-container">
          <h3>性能指标</h3>
          <div id="performanceChart" class="chart"></div>
        </div>
      </el-col>
      <el-col :span="12">
        <div class="chart-container">
          <h3>浏览器兼容性</h3>
          <div id="browserChart" class="chart"></div>
        </div>
      </el-col>
    </el-row>

    <div class="test-list">
      <h3>测试详情</h3>
      
      <div class="filters">
        <el-space>
          <el-select v-model="filter.status" placeholder="状态筛选" clearable>
            <el-option label="全部" value="" />
            <el-option label="通过" value="passed" />
            <el-option label="失败" value="failed" />
            <el-option label="跳过" value="skipped" />
          </el-select>
          <el-select v-model="filter.suite" placeholder="测试套件" clearable>
            <el-option label="全部" value="" />
            <el-option v-for="suite in suites" :key="suite" :label="suite" :value="suite" />
          </el-select>
          <el-input v-model="filter.search" placeholder="搜索测试名称" clearable style="width: 300px" />
        </el-space>
      </div>

      <el-table :data="filteredTests" stripe>
        <el-table-column prop="suite" label="测试套件" width="150" />
        <el-table-column prop="name" label="测试名称" />
        <el-table-column prop="status" label="状态" width="100">
          <template #default="scope">
            <el-tag 
              :type="getStatusType(scope.row.status)"
              size="small"
            >
              {{ scope.row.status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="duration" label="耗时(ms)" width="100" />
        <el-table-column prop="error" label="错误信息" show-overflow-tooltip />
        <el-table-column label="操作" width="150">
          <template #default="scope">
            <el-button size="small" @click="viewDetails(scope.row)">详情</el-button>
            <el-button size="small" @click="rerunTest(scope.row)">重跑</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>

    <!-- 测试详情对话框 -->
    <el-dialog v-model="detailDialog" title="测试详情" width="70%">
      <el-descriptions :column="1" border>
        <el-descriptions-item label="测试名称">{{ currentTest.name }}</el-descriptions-item>
        <el-descriptions-item label="测试套件">{{ currentTest.suite }}</el-descriptions-item>
        <el-descriptions-item label="状态">
          <el-tag :type="getStatusType(currentTest.status)">{{ currentTest.status }}</el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="执行时间">{{ currentTest.duration }}ms</el-descriptions-item>
        <el-descriptions-item label="错误信息" v-if="currentTest.error">
          <pre style="margin: 0; white-space: pre-wrap;">{{ currentTest.error }}</pre>
        </el-descriptions-item>
        <el-descriptions-item label="测试步骤" v-if="currentTest.steps">
          <el-timeline>
            <el-timeline-item 
              v-for="(step, index) in currentTest.steps" 
              :key="index"
              :type="step.status === 'passed' ? 'success' : 'danger'"
            >
              {{ step.description }}
            </el-timeline-item>
          </el-timeline>
        </el-descriptions-item>
        <el-descriptions-item label="截图" v-if="currentTest.screenshot">
          <el-image :src="currentTest.screenshot" fit="contain" />
        </el-descriptions-item>
      </el-descriptions>
    </el-dialog>
  </div>

  <script>
    const { createApp } = Vue;
    const { ElMessage } = ElementPlus;

    createApp({
      data() {
        return {
          lastUpdate: new Date().toLocaleString('zh-CN'),
          environment: 'production',
          totalDuration: 0,
          stats: {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            passedPercent: 0,
            failedPercent: 0,
            skippedPercent: 0
          },
          colors: {
            total: '#409eff',
            passed: '#67c23a',
            failed: '#f56c6c',
            skipped: '#e6a23c'
          },
          tests: [],
          filter: {
            status: '',
            suite: '',
            search: ''
          },
          suites: [],
          detailDialog: false,
          currentTest: {},
          charts: {
            suite: null,
            trend: null,
            performance: null,
            browser: null
          }
        };
      },
      computed: {
        filteredTests() {
          return this.tests.filter(test => {
            if (this.filter.status && test.status !== this.filter.status) return false;
            if (this.filter.suite && test.suite !== this.filter.suite) return false;
            if (this.filter.search && !test.name.toLowerCase().includes(this.filter.search.toLowerCase())) return false;
            return true;
          });
        }
      },
      mounted() {
        this.loadTestData();
        this.initCharts();
        
        // 自动刷新
        setInterval(() => {
          this.loadTestData();
        }, 30000); // 每30秒刷新
      },
      methods: {
        async loadTestData() {
          try {
            // 这里应该从实际的测试结果文件加载
            // 现在使用模拟数据
            const mockData = this.generateMockData();
            this.processTestData(mockData);
          } catch (error) {
            ElMessage.error('加载测试数据失败');
          }
        },
        
        generateMockData() {
          const suites = ['用户认证测试', 'AI对话功能测试', '产品管理功能测试', 'WebSocket测试', '性能测试'];
          const statuses = ['passed', 'passed', 'passed', 'failed', 'skipped'];
          const tests = [];
          
          for (let i = 0; i < 50; i++) {
            const suite = suites[Math.floor(Math.random() * suites.length)];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            tests.push({
              id: i + 1,
              name: `测试用例 ${i + 1}`,
              suite: suite,
              status: status,
              duration: Math.floor(Math.random() * 5000) + 100,
              error: status === 'failed' ? '预期值不匹配' : null,
              steps: this.generateSteps(status)
            });
          }
          
          return {
            tests,
            duration: 45.6,
            timestamp: new Date().toISOString()
          };
        },
        
        generateSteps(status) {
          const steps = [
            { description: '打开页面', status: 'passed' },
            { description: '输入测试数据', status: 'passed' },
            { description: '执行操作', status: status === 'failed' ? 'failed' : 'passed' },
            { description: '验证结果', status: status === 'failed' ? 'failed' : 'passed' }
          ];
          return steps;
        },
        
        processTestData(data) {
          this.tests = data.tests;
          this.totalDuration = data.duration;
          this.lastUpdate = new Date(data.timestamp).toLocaleString('zh-CN');
          
          // 计算统计数据
          this.stats.total = this.tests.length;
          this.stats.passed = this.tests.filter(t => t.status === 'passed').length;
          this.stats.failed = this.tests.filter(t => t.status === 'failed').length;
          this.stats.skipped = this.tests.filter(t => t.status === 'skipped').length;
          
          this.stats.passedPercent = Math.round((this.stats.passed / this.stats.total) * 100);
          this.stats.failedPercent = Math.round((this.stats.failed / this.stats.total) * 100);
          this.stats.skippedPercent = Math.round((this.stats.skipped / this.stats.total) * 100);
          
          // 获取所有套件
          this.suites = [...new Set(this.tests.map(t => t.suite))];
          
          // 更新图表
          this.updateCharts();
        },
        
        initCharts() {
          this.charts.suite = echarts.init(document.getElementById('suiteChart'));
          this.charts.trend = echarts.init(document.getElementById('trendChart'));
          this.charts.performance = echarts.init(document.getElementById('performanceChart'));
          this.charts.browser = echarts.init(document.getElementById('browserChart'));
          
          // 响应式
          window.addEventListener('resize', () => {
            Object.values(this.charts).forEach(chart => chart.resize());
          });
        },
        
        updateCharts() {
          // 测试套件分布图
          const suiteData = this.suites.map(suite => ({
            name: suite,
            value: this.tests.filter(t => t.suite === suite).length
          }));
          
          this.charts.suite.setOption({
            tooltip: { trigger: 'item' },
            legend: { orient: 'vertical', left: 'left' },
            series: [{
              name: '测试数量',
              type: 'pie',
              radius: '50%',
              data: suiteData
            }]
          });
          
          // 测试趋势图
          const dates = this.generateDates(7);
          const trendData = {
            passed: dates.map(() => Math.floor(Math.random() * 20) + 30),
            failed: dates.map(() => Math.floor(Math.random() * 5)),
            skipped: dates.map(() => Math.floor(Math.random() * 3))
          };
          
          this.charts.trend.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['通过', '失败', '跳过'] },
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value' },
            series: [
              { name: '通过', type: 'line', data: trendData.passed, smooth: true, itemStyle: { color: '#67c23a' } },
              { name: '失败', type: 'line', data: trendData.failed, smooth: true, itemStyle: { color: '#f56c6c' } },
              { name: '跳过', type: 'line', data: trendData.skipped, smooth: true, itemStyle: { color: '#e6a23c' } }
            ]
          });
          
          // 性能指标图
          this.charts.performance.setOption({
            tooltip: { trigger: 'axis' },
            radar: {
              indicator: [
                { name: '页面加载', max: 3000 },
                { name: 'API响应', max: 2000 },
                { name: '内存使用', max: 100 },
                { name: 'CPU使用', max: 100 },
                { name: '网络延迟', max: 1000 }
              ]
            },
            series: [{
              name: '性能指标',
              type: 'radar',
              data: [{
                value: [1500, 800, 45, 30, 200],
                name: '当前性能'
              }]
            }]
          });
          
          // 浏览器兼容性图
          const browserData = [
            { name: 'Chrome', passed: 45, failed: 2 },
            { name: 'Firefox', passed: 43, failed: 4 },
            { name: 'Safari', passed: 42, failed: 5 }
          ];
          
          this.charts.browser.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['通过', '失败'] },
            xAxis: { type: 'category', data: browserData.map(b => b.name) },
            yAxis: { type: 'value' },
            series: [
              { name: '通过', type: 'bar', data: browserData.map(b => b.passed), itemStyle: { color: '#67c23a' } },
              { name: '失败', type: 'bar', data: browserData.map(b => b.failed), itemStyle: { color: '#f56c6c' } }
            ]
          });
        },
        
        generateDates(days) {
          const dates = [];
          for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('zh-CN'));
          }
          return dates;
        },
        
        getStatusType(status) {
          const types = {
            passed: 'success',
            failed: 'danger',
            skipped: 'warning'
          };
          return types[status] || 'info';
        },
        
        refreshData() {
          ElMessage.success('数据已刷新');
          this.loadTestData();
        },
        
        runTests() {
          ElMessage.info('测试运行功能需要在命令行执行');
        },
        
        viewDetails(test) {
          this.currentTest = test;
          this.detailDialog = true;
        },
        
        rerunTest(test) {
          ElMessage.info(`重新运行测试: ${test.name}`);
        }
      }
    }).use(ElementPlus).mount('#app');
  </script>
</body>
</html>